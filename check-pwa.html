<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWAå®‰è£…æ£€æŸ¥å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .check-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #764ba2; }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” PWAå®‰è£…æ£€æŸ¥å·¥å…·</h1>
    
    <div class="check-item">
        <h3>1. HTTPSæ£€æŸ¥</h3>
        <p id="https-check"></p>
    </div>
    
    <div class="check-item">
        <h3>2. Manifest.jsonæ£€æŸ¥</h3>
        <p id="manifest-check"></p>
        <pre id="manifest-content"></pre>
    </div>
    
    <div class="check-item">
        <h3>3. Service Workeræ£€æŸ¥</h3>
        <p id="sw-check"></p>
        <button onclick="unregisterSW()">æ³¨é”€Service Worker</button>
        <button onclick="registerSW()">é‡æ–°æ³¨å†ŒService Worker</button>
    </div>
    
    <div class="check-item">
        <h3>4. å›¾æ ‡æ–‡ä»¶æ£€æŸ¥</h3>
        <p id="icon-check"></p>
    </div>
    
    <div class="check-item">
        <h3>5. å®‰è£…æç¤º</h3>
        <p id="install-prompt"></p>
        <button id="install-btn" onclick="installPWA()" style="display:none;">å®‰è£…åº”ç”¨</button>
    </div>
    
    <div class="check-item">
        <h3>ğŸ“‹ ä¿®å¤å»ºè®®</h3>
        <div id="suggestions"></div>
    </div>

    <script>
        let deferredPrompt;
        
        // æ£€æŸ¥HTTPS
        function checkHTTPS() {
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const el = document.getElementById('https-check');
            if (isSecure) {
                el.innerHTML = '<span class="success">âœ“ é€šè¿‡</span> - å½“å‰ä½¿ç”¨å®‰å…¨è¿æ¥';
            } else {
                el.innerHTML = '<span class="error">âœ— å¤±è´¥</span> - éœ€è¦ä½¿ç”¨HTTPSæˆ–localhost';
            }
            return isSecure;
        }
        
        // æ£€æŸ¥Manifest
        async function checkManifest() {
            try {
                const response = await fetch('/manifest.json');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½manifest.json');
                const manifest = await response.json();
                document.getElementById('manifest-content').textContent = JSON.stringify(manifest, null, 2);
                
                const checks = [];
                if (!manifest.name) checks.push('ç¼ºå°‘name');
                if (!manifest.short_name) checks.push('ç¼ºå°‘short_name');
                if (!manifest.icons || manifest.icons.length === 0) checks.push('ç¼ºå°‘icons');
                if (!manifest.start_url) checks.push('ç¼ºå°‘start_url');
                
                const el = document.getElementById('manifest-check');
                if (checks.length === 0) {
                    el.innerHTML = '<span class="success">âœ“ é€šè¿‡</span> - Manifesté…ç½®æ­£ç¡®';
                } else {
                    el.innerHTML = `<span class="error">âœ— å¤±è´¥</span> - ${checks.join(', ')}`;
                }
                return checks.length === 0;
            } catch (error) {
                document.getElementById('manifest-check').innerHTML = `<span class="error">âœ— å¤±è´¥</span> - ${error.message}`;
                return false;
            }
        }
        
        // æ£€æŸ¥Service Worker
        async function checkServiceWorker() {
            const el = document.getElementById('sw-check');
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        el.innerHTML = `<span class="success">âœ“ å·²æ³¨å†Œ</span> - Scope: ${registration.scope}`;
                    } else {
                        el.innerHTML = '<span class="warning">âš  æœªæ³¨å†Œ</span> - ç‚¹å‡»æŒ‰é’®æ³¨å†Œ';
                    }
                } catch (error) {
                    el.innerHTML = `<span class="error">âœ— é”™è¯¯</span> - ${error.message}`;
                }
            } else {
                el.innerHTML = '<span class="error">âœ— ä¸æ”¯æŒ</span> - æµè§ˆå™¨ä¸æ”¯æŒService Worker';
            }
        }
        
        // æ£€æŸ¥å›¾æ ‡
        async function checkIcons() {
            const icons = ['/Assets/icon-192.png', '/Assets/icon-512.png'];
            const results = [];
            
            for (const icon of icons) {
                try {
                    const response = await fetch(icon, { method: 'HEAD' });
                    results.push({
                        path: icon,
                        exists: response.ok
                    });
                } catch {
                    results.push({
                        path: icon,
                        exists: false
                    });
                }
            }
            
            const el = document.getElementById('icon-check');
            const allExist = results.every(r => r.exists);
            if (allExist) {
                el.innerHTML = '<span class="success">âœ“ é€šè¿‡</span> - æ‰€æœ‰å›¾æ ‡æ–‡ä»¶å­˜åœ¨';
            } else {
                const missing = results.filter(r => !r.exists).map(r => r.path).join(', ');
                el.innerHTML = `<span class="error">âœ— å¤±è´¥</span> - ç¼ºå°‘å›¾æ ‡: ${missing}`;
            }
            return allExist;
        }
        
        // æ³¨å†ŒService Worker
        async function registerSW() {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                console.log('Service Workeræ³¨å†ŒæˆåŠŸ:', registration);
                alert('Service Workeræ³¨å†ŒæˆåŠŸï¼è¯·åˆ·æ–°é¡µé¢ã€‚');
                checkServiceWorker();
            } catch (error) {
                alert('Service Workeræ³¨å†Œå¤±è´¥: ' + error.message);
                console.error('æ³¨å†Œå¤±è´¥:', error);
            }
        }
        
        // æ³¨é”€Service Worker
        async function unregisterSW() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.unregister();
                    alert('Service Workerå·²æ³¨é”€ï¼è¯·åˆ·æ–°é¡µé¢ã€‚');
                    checkServiceWorker();
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°å·²æ³¨å†Œçš„Service Worker');
                }
            } catch (error) {
                alert('æ³¨é”€å¤±è´¥: ' + error.message);
            }
        }
        
        // å®‰è£…PWA
        async function installPWA() {
            if (!deferredPrompt) {
                alert('å®‰è£…æç¤ºä¸å¯ç”¨');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('ç”¨æˆ·é€‰æ‹©:', outcome);
            deferredPrompt = null;
            document.getElementById('install-btn').style.display = 'none';
        }
        
        // ç›‘å¬å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').innerHTML = '<span class="success">âœ“ å¯ä»¥å®‰è£…</span>';
            document.getElementById('install-btn').style.display = 'inline-block';
        });
        
        // ç”Ÿæˆä¿®å¤å»ºè®®
        function generateSuggestions() {
            const suggestions = [];
            
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                suggestions.push('ä½¿ç”¨HTTPSæˆ–localhostè®¿é—®ï¼ˆService Workeréœ€è¦å®‰å…¨è¿æ¥ï¼‰');
            }
            
            if (!navigator.serviceWorker) {
                suggestions.push('æµè§ˆå™¨ä¸æ”¯æŒService Workerï¼Œè¯·ä½¿ç”¨Chromeã€Edgeæˆ–Firefox');
            }
            
            suggestions.push('ç¡®ä¿æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨æœåŠ¡å™¨æ ¹ç›®å½•ä¸‹');
            suggestions.push('æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•');
            suggestions.push('åœ¨Chromeä¸­ï¼šè®¾ç½® > éšç§è®¾ç½®å’Œå®‰å…¨æ€§ > ç½‘ç«™è®¾ç½® > Service Workerï¼Œç¡®ä¿å·²å¯ç”¨');
            
            const el = document.getElementById('suggestions');
            el.innerHTML = '<ul>' + suggestions.map(s => `<li>${s}</li>`).join('') + '</ul>';
        }
        
        // åˆå§‹åŒ–æ£€æŸ¥
        window.addEventListener('load', async () => {
            checkHTTPS();
            await checkManifest();
            await checkServiceWorker();
            await checkIcons();
            generateSuggestions();
            
            // å®šæœŸæ›´æ–°Service WorkerçŠ¶æ€
            setInterval(checkServiceWorker, 2000);
        });
    </script>
</body>
</html>
